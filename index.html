<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üöÄ Robot de Pr√©diction Pro - Version Am√©lior√©e</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: .5; }
    }
    .animate-pulse { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }

    @keyframes bounce {
        0%, 100% { transform: translateY(-25%); }
        50% { transform: translateY(0); }
    }
    .animate-bounce { animation: bounce 1s infinite; }

    @keyframes fadeIn {
        from { opacity: 0; transform: scale(0.8); }
        to { opacity: 1; transform: scale(1); }
    }
    
    .coefficient-badge {
        display: inline-block;
        background: linear-gradient(145deg, #3B82F6, #1E40AF);
        color: white;
        border-radius: 9999px;
        padding: 0.25rem 0.75rem;
        font-size: 0.875rem;
        margin: 0.25rem;
        animation: fadeIn 0.3s ease-out;
    }
    
    .auto-fetch-container {
        background: linear-gradient(145deg, #f0f4f8, #def1ff);
        border-radius: 12px;
        padding: 15px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.05);
    }
    
    .history-item {
        transition: all 0.3s ease;
    }
    
    .history-item:hover {
        transform: translateY(-3px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    
    .stats-card {
        background: linear-gradient(145deg, #ffffff, #f9fafb);
        border-radius: 12px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        padding: 1rem;
    }
    
    .robot-header {
        background: linear-gradient(135deg, #1e3a8a, #3b82f6);
        color: white;
        border-radius: 12px;
        padding: 1rem;
        margin-bottom: 1rem;
    }
    
    .feature-card {
        background: linear-gradient(145deg, #f0f9ff, #e0f7fa);
        border-radius: 12px;
        padding: 1rem;
        margin-bottom: 0.75rem;
        border: 1px solid #bae6fd;
    }
    
    .duplicate-warning {
        background-color: #fffbeb;
        color: #854d0e;
        border: 1px solid #fde68a;
        padding: 8px;
        border-radius: 6px;
        font-size: 0.85rem;
        text-align: center;
        margin-top: 10px;
        animation: fadeIn 0.5s ease-out;
    }
    
    body {
        background: linear-gradient(135deg, #f0f9ff, #e6f7ff);
        min-height: 100vh;
    }
    
    .dashboard-card {
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 8px rgba(0,0,0,0.05);
        overflow: hidden;
        transition: transform 0.3s ease;
        padding: 1rem;
    }
    
    .dashboard-card:hover {
        transform: translateY(-3px);
    }
    
    .gradient-btn {
        background: linear-gradient(135deg, #3b82f6, #6366f1);
        color: white;
        border: none;
        border-radius: 10px;
        padding: 10px 20px;
        font-weight: 600;
        transition: all 0.3s ease;
        font-size: 0.9rem;
    }
    
    .gradient-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(59, 130, 246, 0.25);
    }
    
    .status-badge {
        display: inline-flex;
        align-items: center;
        padding: 3px 10px;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 500;
    }
    
    .status-pending {
        background: #fffbeb;
        color: #d97706;
    }
    
    .status-success {
        background: #dcfce7;
        color: #166534;
    }
    
    .status-failed {
        background: #fee2e2;
        color: #b91c1c;
    }
    
    /* Styles am√©lior√©s pour la pr√©diction des rounds */
    .round-badge {
        display: inline-block;
        background: linear-gradient(145deg, #1d4ed8, #3b82f6);
        color: white;
        border-radius: 8px;
        padding: 0.5rem 1.2rem;
        font-weight: bold;
        font-size: 1.1rem;
        margin: 0.3rem;
        box-shadow: 0 4px 6px rgba(59, 130, 246, 0.2);
        transition: all 0.3s ease;
    }
    
    .prediction-score {
        display: inline-block;
        background: linear-gradient(145deg, #8b5cf6, #c084fc);
        color: white;
        border-radius: 10px;
        padding: 0.2rem 0.6rem;
        font-size: 0.8rem;
        margin-top: 0.5rem;
    }
    
    .validation-container {
        margin-top: 1.2rem;
        padding: 1rem;
        background: linear-gradient(145deg, #f0f9ff, #e0f2fe);
        border-radius: 10px;
        border: 1px solid #bae6fd;
    }
    
    .validation-status {
        padding: 0.6rem;
        border-radius: 6px;
        margin-top: 0.4rem;
        font-size: 0.85rem;
        text-align: center;
        font-weight: 500;
    }
    
    .validation-pending {
        background-color: #fffbeb;
        color: #854d0e;
        border: 1px solid #fde68a;
    }
    
    .validation-success {
        background-color: #dcfce7;
        color: #166534;
        border: 1px solid #86efac;
    }
    
    .validation-failed {
        background-color: #fee2e2;
        color: #b91c1c;
        border: 1px solid #fca5a5;
    }
    
    /* Optimisations mobile */
    @media (max-width: 768px) {
        .container {
            padding-left: 0.75rem;
            padding-right: 0.75rem;
            max-width: 100%;
        }
        
        .robot-header {
            padding: 0.75rem;
            margin-bottom: 0.75rem;
        }
        
        .robot-header h1 {
            font-size: 1.5rem;
        }
        
        .dashboard-card {
            padding: 0.75rem;
            margin-bottom: 0.75rem;
        }
        
        .grid-cols-1 {
            gap: 0.75rem;
        }
        
        .grid-cols-1.md\:grid-cols-2 {
            gap: 0.75rem;
        }
        
        .feature-card {
            padding: 0.75rem;
            margin-bottom: 0.5rem;
        }
        
        .stats-card {
            padding: 0.75rem;
        }
        
        .gradient-btn {
            padding: 8px 16px;
            font-size: 0.85rem;
        }
        
        .auto-fetch-container {
            padding: 12px;
        }
        
        footer {
            padding: 1rem 0;
        }
        
        footer .grid {
            gap: 1.5rem;
        }
    }
    
    @media (max-width: 480px) {
        .container {
            padding-left: 0.5rem;
            padding-right: 0.5rem;
        }
        
        .robot-header h1 {
            font-size: 1.3rem;
        }
        
        .dashboard-card {
            padding: 0.5rem;
        }
        
        .gradient-btn {
            font-size: 0.8rem;
            padding: 6px 12px;
        }
        
        .feature-card {
            padding: 0.5rem;
        }
    }
    </style>
</head>
<body class="bg-gray-50">

<!-- Interface principale -->
<div class="container mx-auto px-2 py-4">
    <div class="robot-header text-center">
        <h1 class="text-3xl font-bold flex items-center justify-center flex-wrap">
            <i class="fas fa-robot mr-2"></i>
            ü§ñ Predicteur Pro 
            <span class="ml-2 bg-green-500 text-white text-xs px-2 py-1 rounded-full">V2.4</span>
        </h1>
        <p class="mt-1 text-blue-100 text-sm">Suivi automatique des pr√©dictions avec validation des rounds</p>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 mt-4">
        <!-- Colonne principale -->
        <div class="lg:col-span-2">
            <div class="dashboard-card">
                <div class="auto-fetch-container">
                    <div class="auto-fetch-header flex justify-between items-center">
                        <div class="auto-fetch-title font-bold text-blue-800 text-sm">
                            <i class="fas fa-sync-alt mr-2"></i> R√©cup√©ration Automatique
                        </div>
                        <div class="auto-fetch-status text-gray-700 text-sm" id="autoFetchStatus">
                            <span class="auto-fetch-dot bg-red-500 rounded-full w-2 h-2 inline-block mr-1"></span>
                            <span>Inactif</span>
                        </div>
                    </div>
                    
                    <div class="coefficients-display mt-3 bg-white rounded-lg p-3" id="coefficientsDisplay">
                        <p class="text-center text-gray-500 text-sm">Les coefficients appara√Ætront ici</p>
                    </div>
                    
                    <div class="flex gap-3 mt-3 flex-wrap">
                        <button onclick="startAutoFetch()" class="flex-1 gradient-btn min-w-[120px]">
                            <i class="fas fa-play mr-2"></i> D√©marrer
                        </button>
                        <button onclick="stopAutoFetch()" class="flex-1 bg-gradient-to-r from-red-500 to-rose-600 text-white py-2 rounded-lg hover:opacity-90 transition font-semibold text-sm min-w-[120px]">
                            <i class="fas fa-stop mr-2"></i> Arr√™ter
                        </button>
                        <button onclick="openAdvancedSettings()" class="flex-1 bg-gradient-to-r from-green-500 to-teal-600 text-white py-2 rounded-lg hover:opacity-90 transition font-semibold text-sm min-w-[120px]">
                            <i class="fas fa-cog mr-2"></i> Options
                        </button>
                    </div>
                </div>
                
                <div id="result" class="bg-gray-50 rounded-lg p-4 mt-4 border border-gray-200">
                    <div class="text-center text-gray-600">
                        Les pr√©dictions appara√Ætront ici automatiquement
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Colonne de droite -->
        <div>
            <div class="stats-card mb-4">
                <h3 class="text-lg font-bold text-gray-800 mb-3">
                    <i class="fas fa-chart-pie text-purple-500 mr-2"></i>
                    Statistiques Globales
                </h3>
                <div id="statsContainer" class="text-center">
                    <p id="totalPredictions" class="text-2xl font-bold text-blue-600">0</p>
                    <p id="predictionAccuracy" class="text-xl font-bold text-green-600 mt-1">0%</p>
                    <div class="grid grid-cols-3 gap-3 mt-3">
                        <div class="bg-green-100 p-2 rounded-lg">
                            <p class="text-lg font-bold text-green-800">‚úÖ</p>
                            <p class="text-xs text-gray-700">Valid√©es</p>
                            <p id="successCount" class="font-bold">0</p>
                        </div>
                        <div class="bg-red-100 p-2 rounded-lg">
                            <p class="text-lg font-bold text-red-800">‚ùå</p>
                            <p class="text-xs text-gray-700">√âchou√©es</p>
                            <p id="failedCount" class="font-bold">0</p>
                        </div>
                        <div class="bg-yellow-100 p-2 rounded-lg">
                            <p class="text-lg font-bold text-yellow-800">‚è≥</p>
                            <p class="text-xs text-gray-700">En attente</p>
                            <p id="pendingCount" class="font-bold">0</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="stats-card mb-4">
                <div class="flex justify-between items-center mb-3">
                    <h3 class="text-lg font-bold text-gray-800">
                        <i class="fas fa-brain text-indigo-500 mr-2"></i>
                        Analyse Intelligence
                    </h3>
                    <button onclick="analyzeHistoricalData()" class="bg-gradient-to-r from-purple-500 to-indigo-600 text-white px-2 py-1 rounded-lg text-xs hover:opacity-90 transition">
                        Actualiser
                    </button>
                </div>
                <div id="intelligentAnalysis" class="text-xs space-y-2">
                    <div class="animate-pulse text-gray-500">
                        Cliquez sur Actualiser pour analyser les donn√©es
                    </div>
                </div>
            </div>
            
            <div class="dashboard-card">
                <div class="flex justify-between items-center mb-3">
                    <h3 class="text-lg font-bold text-gray-800">
                        <i class="fas fa-history text-blue-500 mr-2"></i>
                        Historique des Pr√©dictions
                    </h3>
                    <button id="toggleHistory" class="bg-gradient-to-r from-blue-500 to-indigo-600 text-white px-2 py-1 rounded-lg text-xs hover:opacity-90 transition" onclick="toggleHistoryVisibility()">
                        Masquer
                    </button>
                </div>
                <div id="predictionHistory" class="space-y-3 max-h-[400px] overflow-y-auto pr-1 text-sm"></div>
            </div>
        </div>
    </div>
    
    <!-- Section Fonctionnalit√©s -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-4">
        <div class="feature-card">
            <div class="text-blue-500 text-2xl mb-2">
                <i class="fas fa-bolt"></i>
            </div>
            <h4 class="font-bold text-base text-gray-800 mb-1">Suivi Automatique</h4>
            <p class="text-gray-600 text-sm">Le syst√®me v√©rifie automatiquement le succ√®s de chaque pr√©diction sur les 5 rounds suivants.</p>
        </div>
        
        <div class="feature-card">
            <div class="text-green-500 text-2xl mb-2">
                <i class="fas fa-robot"></i>
            </div>
            <h4 class="font-bold text-base text-gray-800 mb-1">IA Avanc√©e</h4>
            <p class="text-gray-600 text-sm">Algorithmes intelligents pour pr√©dire les c√¥tes avec une pr√©cision optimale.</p>
        </div>
        
        <div class="feature-card">
            <div class="text-purple-500 text-2xl mb-2">
                <i class="fas fa-chart-line"></i>
            </div>
            <h4 class="font-bold text-base text-gray-800 mb-1">Analyse en Temps R√©el</h4>
            <p class="text-gray-600 text-sm">Visualisez l'√©volution de vos pr√©dictions gr√¢ce √† des graphiques interactifs.</p>
        </div>
    </div>
</div>

<footer class="bg-gradient-to-r from-gray-800 to-gray-900 text-white py-6 mt-8">
    <div class="container mx-auto px-4">
        <div class="flex flex-col items-center">
            <div class="mb-4">
                <h3 class="text-lg font-bold">ü§ñ Predicteur Pro V2.4</h3>
                <p class="text-gray-300 text-sm mt-1">Syst√®me de pr√©diction automatique optimis√©</p>
            </div>
            <div class="border-t border-gray-700 pt-4 text-center text-gray-400 text-sm">
                <p>&copy; 2023 Predicteur Pro. Tous droits r√©serv√©s.</p>
                <p class="mt-1 text-xs">Version 2.4 - Syst√®me de v√©rification 5 rounds</p>
            </div>
        </div>
    </div>
</footer>

<script>
    // URL du backend int√©gr√©e directement
    const BACKEND_URL = 'https://backend-bot-crash-v2-4.onrender.com';
    
    // Variables globales
    let predictionHistory = [];
    let isHistoryVisible = true;
    let autoCoefficients = [];
    let autoFetchInterval = null;
    let pendingVerification = [];
    let isAutoFetchActive = false;
    
    // Variables pour le contr√¥le des doublons
    let lastCoefficient = null;
    let lastFetchTime = null;
    
    // Initialisation au chargement
    document.addEventListener('DOMContentLoaded', () => {
        // Charger l'historique depuis le backend
        loadHistoryFromBackend();
        
        // Charger les statistiques
        loadStatsFromBackend();
        
        // Afficher le guide au d√©marrage
        setTimeout(() => {
            showGuide();
        }, 1000);
    });

    // Fonction pour d√©marrer la r√©cup√©ration automatique
    async function startAutoFetch() {
        if (autoFetchInterval) return;
        
        isAutoFetchActive = true;
        const statusElement = document.getElementById('autoFetchStatus');
        statusElement.innerHTML = `
            <span class="bg-green-500 rounded-full w-2 h-2 inline-block mr-1"></span>
            <span>R√©cup√©ration en cours...</span>
            <span class="fetching-spinner ml-2 w-3 h-3 border-2 border-blue-500 border-t-transparent rounded-full inline-block animate-spin"></span>
        `;
        
        // D√©marrer imm√©diatement une premi√®re r√©cup√©ration
        await fetchLatestCoefficient();
        
        // Puis configurer l'intervalle
        autoFetchInterval = setInterval(async () => {
            await fetchLatestCoefficient();
        }, 5000);
        
        Swal.fire({
            icon: 'success',
            title: 'R√©cup√©ration d√©marr√©e',
            text: 'Les coefficients seront r√©cup√©r√©s automatiquement toutes les 5 secondes',
            timer: 2000,
            toast: true,
            position: 'top'
        });
    }
    
    // Fonction pour arr√™ter la r√©cup√©ration automatique
    function stopAutoFetch() {
        if (autoFetchInterval) {
            clearInterval(autoFetchInterval);
            autoFetchInterval = null;
            isAutoFetchActive = false;
            
            // R√©initialiser les variables de contr√¥le des doublons
            lastCoefficient = null;
            lastFetchTime = null;
            
            const statusElement = document.getElementById('autoFetchStatus');
            statusElement.innerHTML = `
                <span class="bg-red-500 rounded-full w-2 h-2 inline-block mr-1"></span>
                <span>Inactif</span>
            `;
            
            Swal.fire({
                icon: 'info',
                title: 'R√©cup√©ration arr√™t√©e',
                timer: 1500,
                toast: true,
                position: 'top'
            });
        }
    }
    
    // R√âCUP√âRATION DES COEFFICIENTS via le backend
    async function fetchLatestCoefficient() {
        try {
            const response = await fetch(`${BACKEND_URL}/api/coefficients`);
            if (!response.ok) throw new Error("Erreur de connexion");

            const data = await response.json();
            
            if (data.success && data.coefficient !== null) {
                const roundedCoefficient = parseFloat(data.coefficient.toFixed(2));
                const now = Date.now();
                
                // V√©rifier si le coefficient est identique au pr√©c√©dent et dans un intervalle < 7s
                if (lastCoefficient === roundedCoefficient && lastFetchTime && (now - lastFetchTime) < 7000) {
                    // Afficher un avertissement temporaire
                    showDuplicateWarning();
                    return;
                }
                
                // Mettre √† jour les variables de contr√¥le
                lastCoefficient = roundedCoefficient;
                lastFetchTime = now;
                
                autoCoefficients.push(roundedCoefficient);
                updateCoefficientsDisplay();
                
                // V√©rification des pr√©dictions en attente
                await verifyPendingPredictions(roundedCoefficient);
                
                // Si 5 coefficients, d√©clencher la pr√©diction
                if (autoCoefficients.length >= 5) {
                    await triggerPrediction(true);
                    
                    setTimeout(() => {
                        autoCoefficients = [];
                        updateCoefficientsDisplay();
                    }, 1000);
                }
            }
        } catch (error) {
            console.error("Erreur lors de la r√©cup√©ration:", error);
            
            Swal.fire({
                icon: 'error',
                title: 'Erreur de connexion',
                text: 'V√©rifiez votre connexion internet',
                toast: true,
                position: 'top'
            });
        }
    }
    
    function showDuplicateWarning() {
        const displayElement = document.getElementById('coefficientsDisplay');
        if (!displayElement.querySelector('.duplicate-warning')) {
            const warningElement = document.createElement('div');
            warningElement.className = 'duplicate-warning';
            warningElement.innerHTML = `
                <i class="fas fa-exclamation-triangle mr-2"></i>
                Coefficient identique d√©tect√© (ignor√©)
            `;
            displayElement.appendChild(warningElement);
            
            // Supprimer l'avertissement apr√®s 3 secondes
            setTimeout(() => {
                if (warningElement.parentNode) {
                    warningElement.parentNode.removeChild(warningElement);
                }
            }, 3000);
        }
    }
    
    // V√©rification des pr√©dictions en attente via le backend
    async function verifyPendingPredictions(newCoefficient) {
        const updatedPending = [];
        
        for (const pending of pendingVerification) {
            try {
                const response = await fetch(`${BACKEND_URL}/api/verify`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        predictionId: pending.id,
                        currentCoefficient: newCoefficient,
                        currentRound: pending.currentRound
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    if (data.result.verified) {
                        // Succ√®s - mettre √† jour l'historique
                        await loadHistoryFromBackend();
                        await loadStatsFromBackend();
                        
                        // Supprimer de la v√©rification en attente
                        // (ne pas ajouter √† updatedPending)
                        
                        // Afficher notification
                        Swal.fire({
                            icon: 'success',
                            title: 'Pr√©diction valid√©e!',
                            html: `La pr√©diction ${pending.predictedOdds} a √©t√© valid√©e au Round ${data.result.round}`,
                            toast: true,
                            position: 'top-end',
                            showConfirmButton: false,
                            timer: 3000
                        });
                    } else if (data.result.status === 'failed') {
                        // √âchec apr√®s 5 rounds
                        await loadHistoryFromBackend();
                        await loadStatsFromBackend();
                        
                        // Supprimer de la v√©rification en attente
                        // (ne pas ajouter √† updatedPending)
                        
                        Swal.fire({
                            icon: 'error',
                            title: 'Pr√©diction √©chou√©e',
                            html: `La pr√©diction ${pending.predictedOdds} n'a pas √©t√© valid√©e dans les 5 rounds`,
                            toast: true,
                            position: 'top-end',
                            showConfirmButton: false,
                            timer: 3000
                        });
                    } else {
                        // Toujours en attente - mettre √† jour le round
                        pending.currentRound = data.result.currentRound;
                        updatedPending.push(pending);
                    }
                }
            } catch (error) {
                console.error('Erreur lors de la v√©rification:', error);
                // Garder en attente en cas d'erreur
                updatedPending.push(pending);
            }
        }
        
        pendingVerification = updatedPending;
        // Mettre √† jour l'affichage de l'historique pour refl√©ter les rounds actuels
        updatePredictionHistory();
    }
    
    // Fonction pour d√©clencher une pr√©diction via le backend
    async function triggerPrediction(autoTriggered = false) {
        const settings = JSON.parse(localStorage.getItem('predictionSettings')) || {
            analysisMode: 'pro',
            excludeExtremes: true,
            trendAnalysis: false
        };

        try {
            const response = await fetch(`${BACKEND_URL}/api/predict`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    coefficients: autoCoefficients,
                    settings: settings
                })
            });

            const data = await response.json();
            
            if (data.success) {
                const predictionResult = data.prediction;
                
                // Ajouter √† la v√©rification automatique si d√©clench√© automatiquement
                if (autoTriggered && isAutoFetchActive) {
                    pendingVerification.push({
                        id: predictionResult.id,
                        predictedOdds: parseFloat(predictionResult.averageOdds),
                        currentRound: 1
                    });
                }

                updatePredictionDisplay(predictionResult);
                await loadHistoryFromBackend();
                await loadStatsFromBackend();
                await analyzeHistoricalData();

                Swal.fire({
                    icon: 'success',
                    title: 'Pr√©diction G√©n√©r√©e!',
                    html: `
                        <div class="text-left text-sm">
                            <p>C√¥te moyenne: ${predictionResult.averageOdds}</p>
                            <p class="text-gray-600">Probabilit√©: ${predictionResult.probabilities[0]}%</p>
                            <p class="text-gray-600">Mode: ${settings.analysisMode}</p>
                        </div>
                    `,
                    toast: true,
                    position: 'top',
                    showConfirmButton: false,
                    timer: 3000
                });
            } else {
                throw new Error(data.error);
            }
        } catch (error) {
            Swal.fire({
                icon: 'error',
                title: 'Erreur de pr√©diction',
                text: error.message,
                confirmButtonColor: '#3B82F6',
                toast: true,
                position: 'top'
            });
        }
    }
    
    // Fonction pour charger l'historique depuis le backend
    async function loadHistoryFromBackend() {
        try {
            const response = await fetch(`${BACKEND_URL}/api/history`);
            const data = await response.json();
            
            if (data.success) {
                predictionHistory = data.history;
                updatePredictionHistory();
                updateStatistics(data.stats);
            }
        } catch (error) {
            console.error('Erreur lors du chargement de l\'historique:', error);
        }
    }
    
    // Fonction pour charger les statistiques depuis le backend
    async function loadStatsFromBackend() {
        try {
            const response = await fetch(`${BACKEND_URL}/api/stats`);
            const data = await response.json();
            
            if (data.success) {
                updateStatistics(data.stats);
            }
        } catch (error) {
            console.error('Erreur lors du chargement des statistiques:', error);
        }
    }
    
    // Fonction pour mettre √† jour l'affichage des coefficients
    function updateCoefficientsDisplay() {
        const displayElement = document.getElementById('coefficientsDisplay');
        
        if (autoCoefficients.length === 0) {
            displayElement.innerHTML = '<p class="text-center text-gray-500 text-sm">Les coefficients appara√Ætront ici</p>';
            return;
        }
        
        displayElement.innerHTML = `
            <div class="flex flex-wrap justify-center">
                ${autoCoefficients.map(coef => `
                    <div class="coefficient-badge text-xs">${coef}</div>
                `).join('')}
            </div>
            <div class="text-center mt-2 text-xs text-gray-600">
                ${5 - autoCoefficients.length} coefficient(s) restant(s) avant pr√©diction
            </div>
        `;
    }
    
    function updatePredictionDisplay(prediction) {
        // Trouver l'information de v√©rification en cours
        const pendingInfo = pendingVerification.find(p => p.id === prediction.id);
        const isPending = pendingInfo && prediction.verificationStatus === 'pending';
        
        // Statut de v√©rification
        let verificationStatus = '';
        
        if (isPending) {
            const currentRound = pendingInfo ? pendingInfo.currentRound : 1;
            
            verificationStatus = `
                <div class="validation-container">
                    <div class="validation-status validation-pending">
                        <i class="fas fa-sync-alt fa-spin mr-2"></i>
                        V√©rification en cours - Round ${currentRound}/5
                    </div>
                    <p class="text-xs text-center mt-2 text-gray-600">
                        Le syst√®me v√©rifie automatiquement cette pr√©diction sur les 5 prochains rounds
                    </p>
                </div>
            `;
        } else if (prediction.verificationStatus === 'success') {
            verificationStatus = `
                <div class="validation-container">
                    <div class="validation-status validation-success">
                        <i class="fas fa-check-circle mr-2"></i>
                        ‚úÖ Valid√© au Round ${prediction.verifiedRound}
                    </div>
                    <p class="text-xs text-center mt-2 text-green-600 font-medium">
                        Cette pr√©diction a √©t√© valid√©e avec succ√®s!
                    </p>
                </div>
            `;
        } else if (prediction.verificationStatus === 'failed') {
            verificationStatus = `
                <div class="validation-container">
                    <div class="validation-status validation-failed">
                        <i class="fas fa-times-circle mr-2"></i>
                        ‚ùå √âchou√© apr√®s 5 rounds
                    </div>
                    <p class="text-xs text-center mt-2 text-red-600 font-medium">
                        Cette pr√©diction n'a pas √©t√© valid√©e dans les 5 rounds
                    </p>
                </div>
            `;
        }
        
        document.getElementById('result').innerHTML = `
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="text-center p-3 bg-blue-50 rounded-lg">
                    <span class="text-xs text-gray-600 block mb-1">C√¥te Probable</span>
                    <p class="text-2xl font-bold text-blue-600">${prediction.averageOdds}</p>
                </div>
                
                <div class="text-center p-3 bg-green-50 rounded-lg">
                    <span class="text-xs text-gray-600 block mb-1">Probabilit√© de R√©ussite</span>
                    <p class="text-2xl font-bold text-green-600">${prediction.probabilities[0]}%</p>
                </div>
            </div>
            ${verificationStatus}
        `;
    }
    
    function updatePredictionHistory() {
        const historyContainer = document.getElementById('predictionHistory');
        historyContainer.innerHTML = predictionHistory.map((prediction) => {
            // V√©rifier si cette pr√©diction est en cours de v√©rification
            const pendingInfo = pendingVerification.find(p => p.id === prediction.id);
            const isPendingVerification = pendingInfo && prediction.verificationStatus === 'pending';
            
            // D√©terminer le round actuel pour l'affichage
            let currentRoundDisplay = '';
            if (isPendingVerification) {
                currentRoundDisplay = pendingInfo.currentRound;
            }
            
            return `
            <div class="history-item bg-white border border-gray-200 p-3 rounded-lg">
                <div class="flex justify-between items-start">
                    <div class="flex-1">
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="font-semibold text-gray-800 text-sm">${prediction.date}</p>
                                <p class="text-xs text-gray-600">
                                    Pr√©diction: <span class="font-bold text-blue-600">${prediction.averageOdds}</span> 
                                    <span class="ml-1">(${prediction.probabilities[0]}%)</span>
                                </p>
                            </div>
                            <div>
                                ${prediction.status === 'pending' ? `
                                    <span class="status-badge status-pending text-xs">En attente</span>
                                ` : prediction.status === 'success' ? `
                                    <span class="status-badge status-success text-xs">Valid√©e</span>
                                ` : `
                                    <span class="status-badge status-failed text-xs">√âchou√©e</span>
                                `}
                            </div>
                        </div>
                        
                        <!-- Statut de v√©rification -->
                        ${isPendingVerification ? `
                            <div class="mt-2 text-xs bg-orange-50 text-orange-800 p-1.5 rounded">
                                <i class="fas fa-sync-alt fa-spin mr-1"></i>
                                V√©rification en cours: 
                                <span class="font-bold">Round ${currentRoundDisplay}/5</span>
                            </div>
                        ` : ''}
                        
                        ${prediction.verificationStatus === 'success' ? `
                            <div class="mt-2 text-xs bg-green-50 text-green-800 p-1.5 rounded">
                                <i class="fas fa-check-circle mr-1"></i>
                                Valid√© au Round ${prediction.verifiedRound}
                            </div>
                        ` : ''}
                        
                        ${prediction.verificationStatus === 'failed' ? `
                            <div class="mt-2 text-xs bg-red-50 text-red-800 p-1.5 rounded">
                                <i class="fas fa-times-circle mr-1"></i>
                                √âchou√© apr√®s 5 rounds
                            </div>
                        ` : ''}
                    </div>
                </div>
            </div>
            `;
        }).join('');
    }
    
    function updateStatistics(stats = null) {
        if (!stats) {
            const total = predictionHistory.length;
            const success = predictionHistory.filter(p => p.status === 'success').length;
            const failed = predictionHistory.filter(p => p.status === 'failed').length;
            const pending = predictionHistory.filter(p => p.status === 'pending').length;
            
            const accuracy = total > 0 
                ? ((success / total) * 100).toFixed(1)
                : '0';

            document.getElementById('totalPredictions').textContent = total;
            document.getElementById('predictionAccuracy').textContent = accuracy + '%';
            document.getElementById('successCount').textContent = success;
            document.getElementById('failedCount').textContent = failed;
            document.getElementById('pendingCount').textContent = pending;
        } else {
            document.getElementById('totalPredictions').textContent = stats.totalPredictions;
            document.getElementById('predictionAccuracy').textContent = stats.predictionAccuracy + '%';
            document.getElementById('successCount').textContent = stats.successCount;
            document.getElementById('failedCount').textContent = stats.failedCount;
            document.getElementById('pendingCount').textContent = stats.pendingCount;
        }
    }
    
    function openAdvancedSettings() {
        const currentSettings = JSON.parse(localStorage.getItem('predictionSettings')) || {
            analysisMode: 'pro',
            excludeExtremes: true,
            trendAnalysis: false
        };

        Swal.fire({
            title: '‚öôÔ∏è Param√®tres Avanc√©s',
            html: `
                <div class="grid grid-cols-1 gap-3 text-sm">
                    <div class="text-left">
                        <label class="block text-gray-700 mb-1 font-semibold">Mode d'Analyse</label>
                        <select id="analysisMode" class="w-full p-2 border border-gray-300 rounded-lg">
                            <option value="standard" ${currentSettings.analysisMode === 'standard' ? 'selected' : ''}>
                                Standard (Moyenne simple)
                            </option>
                            <option value="advanced" ${currentSettings.analysisMode === 'advanced' ? 'selected' : ''}>
                                Avanc√© (Pond√©ration adaptative)
                            </option>
                            <option value="pro" ${currentSettings.analysisMode === 'pro' ? 'selected' : ''}>
                                Professionnel (Analyse compl√®te) - RECOMMAND√â
                            </option>
                        </select>
                    </div>
                    <div class="text-left">
                        <label class="block text-gray-700 mb-1 font-semibold">Options d'Analyse</label>
                        <div class="space-y-1">
                            <label class="flex items-center p-1.5 bg-gray-50 rounded-lg">
                                <input type="checkbox" id="excludeExtremes" class="mr-2 h-4 w-4" 
                                    ${currentSettings.excludeExtremes ? 'checked' : ''}>
                                Exclure les valeurs extr√™mes - RECOMMAND√â
                            </label>
                            <label class="flex items-center p-1.5 bg-gray-50 rounded-lg">
                                <input type="checkbox" id="trendAnalysis" class="mr-2 h-4 w-4"
                                    ${currentSettings.trendAnalysis ? 'checked' : ''}>
                                Analyse tendancielle
                            </label>
                        </div>
                    </div>
                    <div class="text-xs text-gray-500 p-2 bg-blue-50 rounded-lg">
                        <i class="fas fa-lightbulb text-yellow-500 mr-1"></i>
                        <span class="font-semibold">Configuration optimale:</span> Mode Professionnel + Exclure valeurs extr√™mes
                    </div>
                </div>
            `,
            showCancelButton: true,
            confirmButtonText: 'Sauvegarder',
            cancelButtonText: 'Annuler',
            confirmButtonColor: '#3B82F6',
            cancelButtonColor: '#EF4444',
            preConfirm: () => {
                const settings = {
                    analysisMode: document.getElementById('analysisMode').value,
                    excludeExtremes: document.getElementById('excludeExtremes').checked,
                    trendAnalysis: document.getElementById('trendAnalysis').checked
                };
                localStorage.setItem('predictionSettings', JSON.stringify(settings));
                return settings;
            }
        }).then((result) => {
            if (result.isConfirmed) {
                Swal.fire({
                    icon: 'success',
                    title: 'Param√®tres sauvegard√©s',
                    text: 'La configuration a √©t√© mise √† jour avec succ√®s',
                    toast: true,
                    position: 'top',
                    showConfirmButton: false,
                    timer: 1500
                });
            }
        });
    }
    
    async function analyzeHistoricalData() {
        try {
            const response = await fetch(`${BACKEND_URL}/api/analyze`);
            const data = await response.json();
            
            if (data.success) {
                if (!data.analysis.hasData) {
                    document.getElementById('intelligentAnalysis').innerHTML = `
                        <div class="text-center text-gray-500 p-3 text-xs">
                            <i class="fas fa-database text-2xl text-gray-400 mb-2"></i>
                            <p>Pas encore assez de donn√©es pour l'analyse</p>
                        </div>
                    `;
                    return;
                }

                const analysis = data.analysis;
                
                document.getElementById('intelligentAnalysis').innerHTML = `
                    <div class="space-y-3">
                        <div class="p-2 bg-purple-50 rounded-lg">
                            <div class="font-bold text-purple-800 mb-1 text-sm">
                                <i class="fas fa-chart-line mr-1"></i>
                                Meilleur Intervalle de Probabilit√©
                            </div>
                            <p class="text-purple-600 text-xs">
                                ${analysis.percentageRanges.bestRange}% (${analysis.percentageRanges.bestCount} succ√®s)
                                <span class="block text-purple-500 text-xs">
                                    Taux de r√©ussite: ${analysis.percentageRanges.successRate}%
                                </span>
                            </p>
                        </div>

                        <div class="p-2 bg-blue-50 rounded-lg">
                            <div class="font-bold text-blue-800 mb-1 text-sm">
                                <i class="fas fa-flag-checkered mr-1"></i>
                                Round le Plus Performant
                            </div>
                            <p class="text-blue-600 text-xs">
                                Round ${analysis.roundAnalysis.bestRound}
                                <span class="block text-blue-500 text-xs">
                                    (${analysis.roundAnalysis.roundCount} succ√®s sur ${analysis.roundAnalysis.totalForRound} pr√©dictions)
                                </span>
                            </p>
                        </div>

                        <div class="p-2 bg-green-50 rounded-lg">
                            <div class="font-bold text-green-800 mb-1 text-sm">
                                <i class="fas fa-trophy mr-1"></i>
                                Meilleures C√¥tes
                            </div>
                            <p class="text-green-600 text-xs">
                                ${analysis.oddsAnalysis.bestRange}
                                <span class="block text-green-500 text-xs">
                                    (${analysis.oddsAnalysis.successCount} succ√®s)
                                </span>
                            </p>
                        </div>

                        <div class="text-center text-xs text-gray-500 mt-2">
                            Analyse bas√©e sur ${analysis.totalSuccessful} pr√©dictions r√©ussies
                        </div>
                    </div>
                `;
            }
        } catch (error) {
            console.error('Erreur lors de l\'analyse:', error);
        }
    }

    function toggleHistoryVisibility() {
        const historyContainer = document.getElementById('predictionHistory');
        const toggleButton = document.getElementById('toggleHistory');
        isHistoryVisible = !isHistoryVisible;
        
        if (isHistoryVisible) {
            historyContainer.style.display = 'block';
            toggleButton.textContent = 'Masquer';
            toggleButton.classList.remove('bg-green-500');
            toggleButton.classList.add('bg-blue-500');
        } else {
            historyContainer.style.display = 'none';
            toggleButton.textContent = 'Afficher';
            toggleButton.classList.remove('bg-blue-500');
            toggleButton.classList.add('bg-green-500');
        }
    }
    
    function showGuide() {
        Swal.fire({
            title: 'üöÄ Guide Complet du Robot de Pr√©diction',
            html: `
                <div class="text-left space-y-4 max-h-[60vh] overflow-y-auto pr-2">
                    <div>
                        <h3 class="text-lg font-bold text-blue-600">üéØ Compatibilit√© des Jeux</h3>
                        <ul class="list-disc pl-5 text-sm">
                            <li>Aviator</li>
                            <li>Crash</li>
                            <li>Jeux √† multiplicateur de c√¥tes</li>
                            <li>Jeux avec progression exponentielle des gains</li>
                        </ul>
                    </div>

                    <div>
                        <h3 class="text-lg font-bold text-indigo-600">üìä Comment Fonctionne le Syst√®me</h3>
                        <div class="bg-indigo-50 p-3 rounded-lg text-sm">
                            <p class="font-bold mb-2">Fonctionnement automatique :</p>
                            <ul class="list-disc pl-5">
                                <li>Cliquez sur "D√©marrer" pour lancer la r√©cup√©ration automatique</li>
                                <li>Le syst√®me analyse les donn√©es toutes les 5 secondes</li>
                                <li>Apr√®s 5 analyses, une pr√©diction est g√©n√©r√©e automatiquement</li>
                                <li class="text-red-600 font-semibold">Important : Le syst√®me optimise automatiquement les calculs</li>
                            </ul>
                        </div>
                    </div>

                    <div>
                        <h3 class="text-lg font-bold text-green-600">‚öôÔ∏è Param√©trage Optimal</h3>
                        <div class="bg-green-50 p-3 rounded-lg text-sm">
                            <p class="font-bold mb-2">Pour une pr√©cision maximale, utilisez ces param√®tres :</p>
                            <ul class="list-disc pl-5">
                                <li><span class="font-semibold">Mode d'Analyse :</span> Professionnel (Analyses compl√®tes)</li>
                                <li><span class="font-semibold">Options d'Analyse :</span>
                                    <ul class="list-circle pl-5">
                                        <li>‚úÖ Cocher "Exclure les valeurs extr√™mes"</li>
                                        <li>‚ùå Ne pas cocher "Analyse tendancielle"</li>
                                    </ul>
                                </li>
                            </ul>
                            <p class="mt-2 text-green-700 font-medium">
                                Ces param√®tres offrent un taux de r√©ussite optimal de 85-95%
                            </p>
                        </div>
                    </div>

                    <div>
                        <h3 class="text-lg font-bold text-orange-600">üé≤ Syst√®me de V√©rification</h3>
                        <ul class="list-disc pl-5 text-sm">
                            <li>Chaque pr√©diction est v√©rifi√©e sur les 5 rounds suivants</li>
                            <li>Le syst√®me affiche le round actuel de v√©rification (1/5, 2/5, etc.)</li>
                            <li>La pr√©diction est valid√©e d√®s qu'elle se r√©alise</li>
                            <li>Si non r√©alis√©e apr√®s 5 rounds, elle est marqu√©e comme √©chou√©e</li>
                        </ul>
                    </div>

                    <div>
                        <h3 class="text-lg font-bold text-purple-600">üèÜ Performances et Pr√©cision</h3>
                        <ul class="list-disc pl-5 text-sm">
                            <li>Pr√©dictions entre 85% et 100% : Tr√®s haute probabilit√© de r√©alisation</li>
                            <li>La pr√©diction appara√Æt g√©n√©ralement dans les 5 rounds successifs</li>
                            <li>Syst√®me optimis√© pour une pr√©cision maximale</li>
                        </ul>
                    </div>

                    <div class="bg-yellow-50 p-3 rounded-lg mt-4">
                        <h3 class="text-lg font-bold text-yellow-600">üí° Conseils d'Utilisation</h3>
                        <div class="text-sm">
                            <ul class="list-disc pl-5">
                                <li>Laissez le syst√®me fonctionner en continu pour de meilleurs r√©sultats</li>
                                <li>Plus le nombre de pr√©dictions est √©lev√©, plus l'analyse est pr√©cise</li>
                                <li>Utilisez les param√®tres recommand√©s pour optimiser les performances</li>
                                <li>Consultez r√©guli√®rement l'analyse intelligence pour adapter votre strat√©gie</li>
                            </ul>
                        </div>
                    </div>

                    <div class="bg-gray-100 p-3 rounded-lg mt-4">
                        <p class="text-sm font-bold text-red-500">‚ö†Ô∏è Avertissement Important</p>
                        <p class="text-xs">Cet outil est une aide √† la d√©cision bas√©e sur des algorithmes avanc√©s. Les jeux comportent toujours des risques. Jouez de mani√®re responsable et dans vos limites.</p>
                    </div>
                </div>
            `,
            width: '600px',
            confirmButtonText: 'Commencer',
            confirmButtonColor: '#3B82F6',
            showClass: {
                popup: 'animate__animated animate__fadeInDown'
            },
            hideClass: {
                popup: 'animate__animated animate__fadeOutUp'
            }
        });
    }
</script>
</body>
</html>